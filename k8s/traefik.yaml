apiVersion: v1
kind: ConfigMap
metadata:
  name: proxy-config
  namespace: grpc-routing-poc
data:
  traefik.yaml: |
    # Static configuration
    global:
      checkNewVersion: false
      sendAnonymousUsage: false

    log:
      level: INFO

    api:
      dashboard: true
      insecure: true

    entryPoints:
      grpc:
        address: ":8443"
        transport:
          lifeCycle:
            requestAcceptGraceTimeout: 0
            graceTimeOut: 10s
          respondingTimeouts:
            readTimeout: 0
            writeTimeout: 0
            idleTimeout: 180s
        http:
          tls:
            options: default
      admin:
        address: ":9901"

    providers:
      file:
        filename: /etc/traefik/dynamic.yaml
        watch: true

  dynamic.yaml: |
    # Dynamic configuration
    http:
      routers:
        grpc-v2:
          entryPoints:
            - grpc
          rule: "HeaderRegexp(`agent-version`, `^v2\\.`)"
          service: server-v2
          priority: 100
          tls: {}

        grpc-v1:
          entryPoints:
            - grpc
          rule: "HeaderRegexp(`agent-version`, `^v1\\.`)"
          service: server-v1
          priority: 90
          tls: {}

        grpc-default:
          entryPoints:
            - grpc
          rule: "PathPrefix(`/`)"
          service: server-v1
          priority: 10
          tls: {}

      services:
        server-v1:
          loadBalancer:
            servers:
              - url: "h2c://server-v1.grpc-routing-poc.svc.cluster.local:50051"

        server-v2:
          loadBalancer:
            servers:
              - url: "h2c://server-v2.grpc-routing-poc.svc.cluster.local:50051"

    tls:
      options:
        default:
          minVersion: VersionTLS12
          sniStrict: false
          alpnProtocols:
            - h2
            - http/1.1

      certificates:
        - certFile: /etc/traefik/certs/cert.pem
          keyFile: /etc/traefik/certs/key.pem

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: proxy-ingress
  namespace: grpc-routing-poc
  labels:
    app: proxy-ingress
    proxy: traefik
spec:
  replicas: 1
  selector:
    matchLabels:
      app: proxy-ingress
      proxy: traefik
  template:
    metadata:
      labels:
        app: proxy-ingress
        proxy: traefik
    spec:
      containers:
      - name: traefik
        image: traefik:v3.2
        ports:
        - containerPort: 8443
          name: grpc
        - containerPort: 9901
          name: admin
        volumeMounts:
        - name: config
          mountPath: /etc/traefik
          readOnly: true
        - name: certs
          mountPath: /etc/traefik/certs
          readOnly: true
        args:
        - --configFile=/etc/traefik/traefik.yaml
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
      volumes:
      - name: config
        configMap:
          name: proxy-config
      - name: certs
        secret:
          secretName: proxy-certs
---
apiVersion: v1
kind: Service
metadata:
  name: proxy-ingress
  namespace: grpc-routing-poc
  labels:
    app: proxy-ingress
spec:
  type: NodePort
  ports:
  - port: 8443
    targetPort: 8443
    nodePort: 30443
    protocol: TCP
    name: grpc
  - port: 9901
    targetPort: 9901
    nodePort: 30901
    protocol: TCP
    name: admin
  selector:
    app: proxy-ingress
